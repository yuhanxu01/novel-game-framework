# 🤖 OpenCode 全自动处理系统

## 📖 简介

这是一个**完全托管**的自动化系统，让 OpenCode（Claude Code）自动处理整部小说，无需人工干预。

### ✨ 核心特性

- 🚀 **一键启动**：运行脚本后完全自动化
- 🔄 **自动恢复**：5小时额度限制自动等待并重启
- 🧠 **AI 自我学习**：在实践中完善脚本和提示词
- 📊 **进度追踪**：实时显示处理进度和统计
- 💾 **断点续传**：支持随时中断和恢复
- 🎯 **智能任务生成**：根据进度自动生成详细指令

## 🚀 快速开始

### 1️⃣ 准备环境

确保已安装：
- OpenCode（Claude Code CLI）
- Python 3.7+
- Git

### 2️⃣ 赋予执行权限

```bash
chmod +x START_AUTO.sh
chmod +x smart_task_generator.py
```

### 3️⃣ 启动自动化

```bash
# 正常模式 - 处理小说章节
./START_AUTO.sh

# 元任务模式 - 让 AI 改进系统本身
./START_AUTO.sh --meta

# 查看当前状态
./START_AUTO.sh --status

# 只运行一次（不自动继续）
./START_AUTO.sh --once
```

### 4️⃣ 放心离开

脚本会自动运行，你可以：
- ☕ 去喝咖啡
- 🛌 去睡觉
- 🎮 去玩游戏

系统会自动处理一切，包括：
- 读取章节
- 分析内容
- 更新数据
- 提交 Git
- 处理额度限制
- 继续下一章

## 📊 系统架构

```
┌─────────────────────────────────────────────────────────┐
│                    START_AUTO.sh                        │
│                   (主控制脚本)                           │
│  ┌─────────┐  ┌──────────┐  ┌──────────┐  ┌─────────┐ │
│  │ 环境检查 │→│ 生成任务  │→│ 启动AI   │→│ 监控状态 │ │
│  └─────────┘  └──────────┘  └──────────┘  └─────────┘ │
└─────────────────────────────────────────────────────────┘
                           ↓
┌─────────────────────────────────────────────────────────┐
│             smart_task_generator.py                     │
│                (智能任务生成器)                          │
│  • 读取当前进度                                          │
│  • 生成详细任务指令                                      │
│  • 学习历史经验                                          │
│  • 提供改进建议                                          │
└─────────────────────────────────────────────────────────┘
                           ↓
┌─────────────────────────────────────────────────────────┐
│                    OpenCode (AI)                        │
│  • 读取小说章节                                          │
│  • 深度分析内容                                          │
│  • 更新所有数据                                          │
│  • 提交 Git                                             │
│  • 自我改进系统                                          │
└─────────────────────────────────────────────────────────┘
```

## 📂 文件说明

### 核心文件

| 文件 | 说明 |
|------|------|
| `START_AUTO.sh` | 主启动脚本（Mac 优化版） |
| `smart_task_generator.py` | 智能任务生成器 |
| `CURRENT_AUTO_TASK.md` | 当前任务指令（自动生成） |
| `auto_runner_state.json` | 运行状态记录 |
| `task_learning.json` | AI 学习记录 |

### 数据文件

| 目录/文件 | 说明 |
|-----------|------|
| `novel/斗破苍穹.txt` | 原始小说文本 |
| `data/chapter_summaries/` | 章节分析结果 |
| `data/characters.json` | 角色数据库 |
| `data/world_setting.json` | 世界观设定 |
| `data/accumulated_context.json` | 累积上下文 |
| `tools/progress.json` | 进度跟踪 |
| `logs/` | 运行日志 |

## 🎯 工作流程

### 正常模式（处理章节）

```
1. 读取 progress.json 获取当前进度
   ↓
2. 生成第 N+1 章的任务指令
   ↓
3. OpenCode 读取章节原文
   ↓
4. 深度分析（角色/情节/世界观）
   ↓
5. 更新所有数据文件
   ↓
6. Git 提交 & Push
   ↓
7. 更新进度到第 N+1 章
   ↓
8. 检查是否需要回顾（每10章）
   ↓
9. 继续下一章 或 进行回顾
```

### 回顾模式（每10章）

```
1. 读取最近 10 章的分析数据
   ↓
2. 统计新增角色/地点/物品
   ↓
3. 质量检查（完整性/一致性/准确性）
   ↓
4. 生成回顾报告
   ↓
5. 自动批准（如质量合格）
   ↓
6. 继续处理下一章
```

### 元任务模式（系统改进）

```
1. 回顾最近的工作日志
   ↓
2. 识别成功模式和常见错误
   ↓
3. 改进提示词（更清晰的指令）
   ↓
4. 改进脚本（修复 bug、优化流程）
   ↓
5. 记录学习成果到 task_learning.json
   ↓
6. 生成改进报告
   ↓
7. Git 提交改进内容
```

## ⚙️ 高级功能

### 1. AI 自我改进

系统允许 OpenCode 修改自己的代码：

```bash
# 让 AI 改进系统
./START_AUTO.sh --meta
```

OpenCode 可以：
- 优化提示词模板
- 修复脚本 bug
- 添加新功能
- 改进工作流程

### 2. 学习系统

系统会记录：
- ✅ 成功的模式（推荐复用）
- ❌ 常见错误（避免重复）
- 💡 改进建议（待实施）
- 📚 最佳实践（指导原则）

记录文件：`task_learning.json`

### 3. 自动额度管理

当触发 5 小时限制：
```
检测到额度限制
  ↓
自动等待 5 小时
  ↓
显示倒计时
  ↓
使用 caffeinate 防止 Mac 休眠
  ↓
等待结束后自动继续
```

### 4. 进度可视化

```bash
./START_AUTO.sh --status
```

输出示例：
```
📊 当前状态
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  当前章节: 第 30 章
  总章节数: 1694 章
  完成进度: 1.8%
  剩余章节: 1664 章
  [█░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░]

📈 运行统计
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  运行次数: 15 次
  已处理章节: 30 章
  额度限制次数: 2 次
  最后运行: 2026-01-13 10:30:15
```

## 🛠️ 故障排除

### 问题 1：找不到 opencode 命令

**解决**：
```bash
# 确认 opencode 已安装
which opencode

# 如未安装，请参考官方文档
# https://github.com/anthropics/claude-code
```

### 问题 2：权限错误

**解决**：
```bash
chmod +x START_AUTO.sh
chmod +x smart_task_generator.py
```

### 问题 3：Git push 失败

**解决**：
```bash
# 检查分支
git branch

# 检查 remote
git remote -v

# 手动 push 测试
git push -u origin claude/automate-novel-writing-rwmkK
```

### 问题 4：进度文件损坏

**解决**：
```bash
# 备份
cp tools/progress.json tools/progress.json.bak

# 修复格式
python3 << 'EOF'
import json
with open('tools/progress.json', 'r') as f:
    data = json.load(f)
with open('tools/progress.json', 'w') as f:
    json.dump(data, f, indent=2)
EOF
```

## 📝 最佳实践

### ✅ 推荐做法

1. **定期查看状态**
   ```bash
   ./START_AUTO.sh --status
   ```

2. **先运行元任务**（让 AI 优化系统）
   ```bash
   ./START_AUTO.sh --meta
   ```

3. **查看生成的报告**
   ```bash
   ls -lt data/reviews/
   cat data/reviews/review_3.md
   ```

4. **检查日志**
   ```bash
   tail -f logs/auto_runner.log
   ```

### ❌ 避免做法

1. ❌ 不要手动修改 progress.json（除非修复错误）
2. ❌ 不要在运行期间修改任务文件
3. ❌ 不要同时运行多个实例
4. ❌ 不要在额度限制时强行继续

## 🎮 实际使用示例

### 场景 1：首次运行

```bash
# 1. 进入项目目录
cd /home/user/novel-game-framework

# 2. 查看当前状态
./START_AUTO.sh --status

# 3. 启动自动化（从第 30 章继续）
./START_AUTO.sh

# 4. 离开，让它运行
# 系统会自动处理 31, 32, 33...章节
```

### 场景 2：中途中断

```bash
# 按 Ctrl+C 中断

# 稍后恢复（自动从上次进度继续）
./START_AUTO.sh
```

### 场景 3：系统优化

```bash
# 让 AI 改进系统本身
./START_AUTO.sh --meta

# AI 会：
# - 分析日志
# - 优化提示词
# - 改进脚本
# - 记录学习成果
```

### 场景 4：额度限制

```
运行中...
检测到额度限制
⏳ 等待 5 小时额度恢复...
开始时间: 2026-01-13 10:00:00
恢复时间: 2026-01-13 15:00:00

⏰ 剩余: 04:59:58

（5小时后）
✅ 等待结束，准备继续
继续处理下一章...
```

## 🔮 未来规划

- [ ] 支持多线程处理（不同章节并行）
- [ ] Web 界面监控
- [ ] 邮件/Slack 通知
- [ ] 更智能的错误恢复
- [ ] 支持其他小说格式
- [ ] 导出统计报告

## 📞 支持

遇到问题？

1. 查看日志：`logs/auto_runner.log`
2. 查看任务：`cat CURRENT_AUTO_TASK.md`
3. 查看学习记录：`cat task_learning.json`
4. 提交 issue 到 GitHub

## 📜 许可

MIT License

---

**享受全自动的快乐吧！** 🎉
